# OC Relay

## State

| State       | Description                                                                   |
|-------------|-------------------------------------------------------------------------------|
| Initialized | The client / server has been created, but is not ready to handle connections. |
| Opening     | The client / server is in the process of getting ready to handle connections. |
| Open        | The client / server is open connection and ready to handle connections.       |
| Closed      | The client / server has been closed connection.                               |

## Connection

A ```Connection``` is a thin wrapper around socket that allows messages to be 
passed between the ```Server``` and ```Client```s. ```Connection```s only 
know how to pass byte arrays around. A ```MessageHandler``` 
(of type ```suspend (ByteArray) -> Unit``` ) is registered, via the 
```listen``` method, that handles incoming messages. 

### Message

The relay client and server use ```Conntection```s to pass ```Message```s, which 
have the following fields 

| Field  | Type         | Description                                    |
|--------|--------------|------------------------------------------------|
| header | ```Header``` | A header containing metadata about the message |
| body   | ```bytes```  | An arbitrary byte array.                       |

### Header

Headers contain metadata about the message. To is not included in this metadata, is it is 
available in the outer envelope of the message.

| Field     | Type            | Description                                                                                             |
|-----------|-----------------|---------------------------------------------------------------------------------------------------------|
| messageId | UUID            | The unique identifier of the message.                                                                   |
| from      | PublicKey       | The public key of the sender of the message.                                                            |
| signature | ```Signature``` | A signature of the message body. The signature is generated by the sender and verified by the receiver. |

### Signature
| Field     | Type         | Description                                   |
|-----------|--------------|-----------------------------------------------|
| algorithm | ```String``` | The algorithm used to generate the signature. |
| bytes     | ```bytes```  | The signature of the message body.            |

### Envelope

| Field   | Type            | Description                                                                                                                                                                                                                                                                      |
|---------|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| to      | ```PublicKey``` | The public key of the recipient of the message.                                                                                                                                                                                                                                  |
| key     | ```bytes```     | **V2 ONLY**: The key (typically the hash of some / all of the message data before encryption) used to control message storage. When not present, the message is considered transient and will **NOT** be stored. When present, only 1 ```Message``` with the same key is stored. |
| message | ```bytes```     | The message to be sent.                                                                                                                                                                                                                                                          |

## Authentication Handshake

When a client connects to the server, a handshake is performed to authenticate both the server and the client. 
are the steps in the handshake:

| Message Source | Action                | Description                                                                                                                                                                            |
|----------------|-----------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Server         | Identify              | The server sends its public key to client                                                                                                                                              |
| Client         | Challenge             | If the server identity is trusted, the client sends a challenge (a set of random bytes) to server                                                                                      |
| Server         | Challenge Response    | The server signs the challenge and sends the signature to the client. There's no need to encrypt the signature, because the server publicly identifies itself.                         |
| Client         | Identify              | The client verifies the challenge, and if valid, sends its public key to the server, encrypted with the server public key.                                                             |
| Server         | Challenge             | The server decrypts the client's public key and if the client is authorized, generates a challenge and sends it to the client.                                                         | 
| Client         | Challenge Response    | The client signs the challenge and sends the encrypted signature to server - encrypting protects against MITM scanning client public keys for signature matches.                       |
| Server         | Authentication Result | The server decrypts and verifies the signature. If the signature is valid, authentication is successful and the server generates a session key to include in an authentication result. |







